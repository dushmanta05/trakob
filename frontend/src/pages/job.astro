---
import Layout from "../layouts/MainLayout.astro";
import { jobAPI } from "../lib/api.js";

const response = await jobAPI.getJobs().catch(err => ({ data: { data: [] } }));
const initialJobs: any[] = response.data.data || response.data;
---

<Layout title="Jobs">
  <div class="flex justify-between items-center mb-6">
    <h2 class="text-2xl font-semibold">Applied Jobs</h2>
    <button class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition-colors" id="addJobBtn">+ Add Job</button>
  </div>

  <div class="overflow-x-auto">
    <table class="min-w-full">
      <thead class="bg-gray-50">
        <tr>
          <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Company</th>
          <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Position</th>
          <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Applied Date</th>
          <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
          <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Package</th>
          <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
        </tr>
      </thead>
      <tbody class="bg-white divide-y divide-gray-200" id="jobsTableBody">
        {initialJobs.map((job: any) => (
          <tr class="hover:bg-gray-50">
            <td class="py-4 px-4 whitespace-nowrap text-sm text-gray-900">{job.companyName}</td>
            <td class="py-4 px-4 whitespace-nowrap text-sm text-gray-900">{job.position}</td>
            <td class="py-4 px-4 whitespace-nowrap text-sm text-gray-500">{new Date(job.appliedDate).toLocaleDateString()}</td>
            <td class="py-4 px-4 whitespace-nowrap">
              <span class={`inline-flex px-2 py-1 text-xs font-semibold rounded-full ${
                job.status === 'ongoing' ? 'bg-yellow-100 text-yellow-800' :
                job.status === 'rejected' ? 'bg-red-100 text-red-800' :
                'bg-green-100 text-green-800'
              }`}>
                {job.status?.charAt(0).toUpperCase() + job.status?.slice(1)}
              </span>
            </td>
            <td class="py-4 px-4 whitespace-nowrap text-sm text-gray-500">{job.package || '-'}</td>
            <td class="py-4 px-4 whitespace-nowrap text-sm">
              <button class="bg-gray-200 text-gray-800 px-3 py-1 rounded mr-2 hover:bg-gray-300 transition-colors edit-btn" data-id={job._id?.toString()}>Edit</button>
              <button class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 transition-colors delete-btn" data-id={job._id?.toString()}>Delete</button>
            </td>
          </tr>
        ))}
      </tbody>
    </table>
  </div>

  <!-- Add/Edit Job Modal -->
  <div id="jobModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50" style="display: none;">
    <div class="bg-white rounded-lg shadow-xl w-11/12 max-w-md p-6">
      <h3 id="modalTitle" class="text-lg font-medium mb-4">Add Job</h3>
      <form id="jobForm">
        <input type="hidden" id="jobId" />
        <div class="mb-4">
          <label for="companyName" class="block text-sm font-medium text-gray-700 mb-1">Company Name</label>
          <input type="text" id="companyName" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" required />
        </div>
        <div class="mb-4">
          <label for="position" class="block text-sm font-medium text-gray-700 mb-1">Position</label>
          <input type="text" id="position" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" required />
        </div>
        <div class="mb-4">
          <label for="appliedDate" class="block text-sm font-medium text-gray-700 mb-1">Applied Date</label>
          <input type="date" id="appliedDate" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" required />
        </div>
        <div class="mb-4">
          <label for="package" class="block text-sm font-medium text-gray-700 mb-1">Package</label>
          <input type="text" id="package" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" />
        </div>
        <div class="mb-4">
          <label for="status" class="block text-sm font-medium text-gray-700 mb-1">Status</label>
          <select id="status" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" required>
            <option value="ongoing">Ongoing</option>
            <option value="rejected">Rejected</option>
            <option value="approved">Approved</option>
          </select>
        </div>
        <div class="mb-4">
          <label for="notes" class="block text-sm font-medium text-gray-700 mb-1">Notes</label>
          <textarea id="notes" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"></textarea>
        </div>
        <div class="mb-4">
          <label for="jobLink" class="block text-sm font-medium text-gray-700 mb-1">Job Link</label>
          <input type="text" id="jobLink" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" />
        </div>
        <div class="flex gap-2">
          <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition-colors">Save</button>
          <button type="button" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300 transition-colors" id="cancelModal">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    import { jobAPI } from '../lib/api.js';

    const addJobBtn = document.getElementById('addJobBtn');
    const jobModal = document.getElementById('jobModal');
    const jobForm = document.getElementById('jobForm') as HTMLFormElement | null;
    const cancelModal = document.getElementById('cancelModal');
    const jobsTableBody = document.getElementById('jobsTableBody');

    const modalTitle = document.getElementById('modalTitle');
    const jobIdInput = document.getElementById('jobId') as HTMLInputElement | null;
    const companyNameInput = document.getElementById('companyName') as HTMLInputElement | null;
    const positionInput = document.getElementById('position') as HTMLInputElement | null;
    const appliedDateInput = document.getElementById('appliedDate') as HTMLInputElement | null;
    const packageInput = document.getElementById('package') as HTMLInputElement | null;
    const statusInput = document.getElementById('status') as HTMLSelectElement | null;
    const notesInput = document.getElementById('notes') as HTMLTextAreaElement | null;
    const jobLinkInput = document.getElementById('jobLink') as HTMLInputElement | null;

    let editingJobId: string | null = null;

    if (addJobBtn) {
      addJobBtn.addEventListener('click', () => {
        if (modalTitle) modalTitle.textContent = 'Add Job';
        if (jobForm) jobForm.reset();
        editingJobId = null;
        if (jobIdInput) jobIdInput.value = '';
        if (jobModal) jobModal.style.display = 'block';
      });
    }

    if (cancelModal) {
      cancelModal.addEventListener('click', () => {
        if (jobModal) jobModal.style.display = 'none';
      });
    }

    if (jobForm) {
      jobForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        if (companyNameInput && positionInput && appliedDateInput && packageInput && statusInput && notesInput && jobLinkInput) {
          const jobData = {
            companyName: companyNameInput.value,
            position: positionInput.value,
            appliedDate: new Date(appliedDateInput.value).getTime(),
            package: packageInput.value,
            status: statusInput.value,
            notes: notesInput.value,
            jobLink: jobLinkInput.value
          };

          try {
            if (editingJobId) {
              await jobAPI.updateJob(editingJobId, jobData);
              alert('Job updated successfully!');
            } else {
              await jobAPI.addJob(jobData);
              alert('Job added successfully!');
            }

            location.reload();
          } catch (error) {
            console.error('Error saving job:', error);
            alert('Error saving job. Please try again.');
          }
        }
      });
    }

    if (typeof document !== 'undefined') {
      document.querySelectorAll('.edit-btn').forEach(button => {
        button.addEventListener('click', async (e) => {
          const target = e.target as HTMLElement;
          if (target && target.getAttribute) {
            const jobId = target.getAttribute('data-id');
            editingJobId = jobId;

            try {
              const response = await jobAPI.getJobById(jobId);
              const job = response.data.data || response.data;

              if (modalTitle) modalTitle.textContent = 'Edit Job';
              if (jobIdInput) jobIdInput.value = job._id;
              if (companyNameInput) companyNameInput.value = job.companyName;
              if (positionInput) positionInput.value = job.position;

              let appliedDateValue = job.appliedDate;
              if (typeof appliedDateValue === 'number') {
                appliedDateValue = new Date(appliedDateValue).toISOString().split('T')[0];
              } else if (typeof appliedDateValue === 'string' || appliedDateValue instanceof Date) {
                appliedDateValue = new Date(appliedDateValue).toISOString().split('T')[0];
              }

              if (appliedDateInput) appliedDateInput.value = appliedDateValue;
              if (packageInput) packageInput.value = job.package;
              if (statusInput) statusInput.value = job.status;
              if (notesInput) notesInput.value = job.notes || '';
              if (jobLinkInput) jobLinkInput.value = job.jobLink || '';

              if (jobModal) jobModal.style.display = 'block';
            } catch (error) {
              console.error('Error fetching job:', error);
              alert('Error fetching job details. Please try again.');
            }
          }
        });
      });

      document.querySelectorAll('.delete-btn').forEach(button => {
        button.addEventListener('click', async (e) => {
          const target = e.target as HTMLElement;
          if (target && target.getAttribute) {
            const jobId = target.getAttribute('data-id');

            if (confirm('Are you sure you want to delete this job?')) {
              try {
                await jobAPI.deleteJob(jobId);
                alert('Job deleted successfully!');
                location.reload();
              } catch (error) {
                console.error('Error deleting job:', error);
                alert('Error deleting job. Please try again.');
              }
            }
          }
        });
      });
    }
  </script>
</Layout>
