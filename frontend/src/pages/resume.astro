---
import Layout from "../layouts/MainLayout.astro";
import { resumeAPI } from "../lib/api.js";

const response = await resumeAPI.getResumes().catch(err => ({ data: { data: [] } }));
const initialResumes: any[] = response.data.data || response.data;
---

<Layout title="Resumes">
  <div class="flex justify-between items-center mb-6">
    <h2 class="text-2xl font-semibold">Resumes</h2>
    <button class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition-colors" id="addResumeBtn">+ Add Resume</button>
  </div>

  <div class="overflow-x-auto">
    <table class="min-w-full">
      <thead class="bg-gray-50">
        <tr>
          <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
          <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Template Type</th>
          <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
          <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Created Date</th>
          <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
        </tr>
      </thead>
      <tbody class="bg-white divide-y divide-gray-200" id="resumesTableBody">
        {initialResumes.map((resume: any) => (
          <tr class="hover:bg-gray-50">
            <td class="py-4 px-4 whitespace-nowrap text-sm text-gray-900">{resume.name}</td>
            <td class="py-4 px-4 whitespace-nowrap text-sm text-gray-500">{resume.templateType || 'default'}</td>
            <td class="py-4 px-4 whitespace-nowrap text-sm text-gray-500">{resume.description || '-'}</td>
            <td class="py-4 px-4 whitespace-nowrap text-sm text-gray-500">{new Date(resume.createdAt).toLocaleDateString()}</td>
            <td class="py-4 px-4 whitespace-nowrap text-sm">
              <button class="bg-gray-200 text-gray-800 px-3 py-1 rounded mr-2 hover:bg-gray-300 transition-colors edit-btn" data-id={resume._id?.toString()}>Edit</button>
              <button class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 transition-colors delete-btn" data-id={resume._id?.toString()}>Delete</button>
            </td>
          </tr>
        ))}
      </tbody>
    </table>
  </div>

  <!-- Add/Edit Resume Modal -->
  <div id="resumeModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50" style="display: none;">
    <div class="bg-white rounded-lg shadow-xl w-11/12 max-w-md p-6">
      <h3 id="resumeModalTitle" class="text-lg font-medium mb-4">Add Resume</h3>
      <form id="resumeForm">
        <input type="hidden" id="resumeId" />
        <div class="mb-4">
          <label for="resumeName" class="block text-sm font-medium text-gray-700 mb-1">Resume Name</label>
          <input type="text" id="resumeName" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" required />
        </div>
        <div class="mb-4">
          <label for="templateType" class="block text-sm font-medium text-gray-700 mb-1">Template Type</label>
          <select id="templateType" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
            <option value="default">Default</option>
            <option value="modern">Modern</option>
            <option value="academic">Academic</option>
          </select>
        </div>
        <div class="mb-4">
          <label for="latexCode" class="block text-sm font-medium text-gray-700 mb-1">LaTeX Code</label>
          <textarea id="latexCode" rows="8" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" required></textarea>
        </div>
        <div class="mb-4">
          <label for="resumeDescription" class="block text-sm font-medium text-gray-700 mb-1">Description</label>
          <textarea id="resumeDescription" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"></textarea>
        </div>
        <div class="flex gap-2">
          <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition-colors">Save</button>
          <button type="button" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300 transition-colors" id="cancelResumeModal">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    import { resumeAPI } from '../lib/api.js';

    const addResumeBtn = document.getElementById('addResumeBtn');
    const resumeModal = document.getElementById('resumeModal');
    const resumeForm = document.getElementById('resumeForm') as HTMLFormElement | null;
    const cancelResumeModal = document.getElementById('cancelResumeModal');

    const resumeModalTitle = document.getElementById('resumeModalTitle');
    const resumeIdInput = document.getElementById('resumeId') as HTMLInputElement | null;
    const resumeNameInput = document.getElementById('resumeName') as HTMLInputElement | null;
    const templateTypeInput = document.getElementById('templateType') as HTMLSelectElement | null;
    const latexCodeInput = document.getElementById('latexCode') as HTMLTextAreaElement | null;
    const resumeDescriptionInput = document.getElementById('resumeDescription') as HTMLTextAreaElement | null;

    let editingResumeId: string | null = null;

    if (addResumeBtn) {
      addResumeBtn.addEventListener('click', () => {
        if (resumeModalTitle) resumeModalTitle.textContent = 'Add Resume';
        if (resumeForm) resumeForm.reset();
        editingResumeId = null;
        if (resumeIdInput) resumeIdInput.value = '';
        if (resumeModal) resumeModal.style.display = 'block';
      });
    }

    if (cancelResumeModal) {
      cancelResumeModal.addEventListener('click', () => {
        if (resumeModal) resumeModal.style.display = 'none';
      });
    }

    if (resumeForm) {
      resumeForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        if (resumeNameInput && templateTypeInput && latexCodeInput && resumeDescriptionInput) {
          const resumeData = {
            name: resumeNameInput.value,
            templateType: templateTypeInput.value,
            latexCode: latexCodeInput.value,
            description: resumeDescriptionInput.value
          };

          try {
            if (editingResumeId) {
              await resumeAPI.updateResume(editingResumeId, resumeData);
              alert('Resume updated successfully!');
            } else {
              await resumeAPI.addResume(resumeData);
              alert('Resume added successfully!');
            }

            location.reload();
          } catch (error) {
            console.error('Error saving resume:', error);
            alert('Error saving resume. Please try again.');
          }
        }
      });
    }

    if (typeof document !== 'undefined') {
      document.querySelectorAll('.edit-btn').forEach(button => {
        button.addEventListener('click', async (e) => {
          const target = e.target as HTMLElement;
          if (target && target.getAttribute) {
            const resumeId = target.getAttribute('data-id');
            editingResumeId = resumeId;

            try {
              const response = await resumeAPI.get(resumeId);
              const resume = response.data.data || response.data;

              if (resumeModalTitle) resumeModalTitle.textContent = 'Edit Resume';
              if (resumeIdInput) resumeIdInput.value = resume._id;
              if (resumeNameInput) resumeNameInput.value = resume.name;
              if (templateTypeInput) templateTypeInput.value = resume.templateType || 'default';
              if (latexCodeInput) latexCodeInput.value = resume.latexCode;
              if (resumeDescriptionInput) resumeDescriptionInput.value = resume.description || '';

              if (resumeModal) resumeModal.style.display = 'block';
            } catch (error) {
              console.error('Error fetching resume:', error);
              alert('Error fetching resume details. Please try again.');
            }
          }
        });
      });

      document.querySelectorAll('.delete-btn').forEach(button => {
        button.addEventListener('click', async (e) => {
          const target = e.target as HTMLElement;
          if (target && target.getAttribute) {
            const resumeId = target.getAttribute('data-id');

            if (confirm('Are you sure you want to delete this resume?')) {
              try {
                await resumeAPI.deleteResume(resumeId);
                alert('Resume deleted successfully!');
                location.reload();
              } catch (error) {
                console.error('Error deleting resume:', error);
                alert('Error deleting resume. Please try again.');
              }
            }
          }
        });
      });
    }
  </script>
</Layout>
